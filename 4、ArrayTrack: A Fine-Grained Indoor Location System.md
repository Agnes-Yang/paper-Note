# ArrayTrack: A Fine-Grained Indoor Location System
## abstract
随着无数的增强现实，社交网络和零售购物应用程序的出现在手持设备的展望，快速而准确的定位技术将成为丰富的用户体验的关键。在室外，用户通常可以依靠清晰的GPS信号来获得准确的位置信息，但是在室内，GPS往往会消失，再加上直到现在，手机主要依靠较粗粒度的信号强度进行读数。室内AP天线数量急剧增加的趋势能够改变这种现状，主要是通过多输入多输出（MIMO）技术来提高容量和覆盖范围。因此，我们以一个全新的视角重新审视定位的重要问题。本文介绍了ArrayTrack的设计和实验评估，这是一个室内定位系统，它使用MIMObased技术在建筑物中漫游时，以非常精细的粒度实时跟踪无线客户端。结合FPGA和通用计算，我们构建了一个ArrayTrack系统的原型。研究结果表明，我们提出的技术可以确定41个客户端在室内办公环境中的分布情况，精确度达到23厘米以内，系统延迟时间仅为100毫秒，这是首次在手机上实现无处不在的实时细粒度定位。
## introduction
Outdoors, these devices largely enjoy a robust and relatively accurate location service from Global Positioning System (GPS) satellite signals, but indoors where GPS signals don’t reach, providing an accurate location service is quite challenging.

此外，精确的定位信息在室内的需求尤其严重。 虽然GPS在户外提供的几米精度足以满足街道导航的需要，但位置上的小差异对于室内人员和应用更为重要：估计位置的几米误差可能使某人处于不同的办公室，一个建筑物，例如。位置感知的智能手机应用程序（如基于增强现实的建筑导航，社交网络和零售购物）需要高准确性和低响应时间。 在室内提供厘米精度的定位服务的解决方案将使这些和其他激动人心的应用程序在移动和普及计算中成为可能。

使用射频（RF）进行定位有许多挑战。 首先，在靠近接入点（AP）和移动客户端的室内的许多对象反射了无线信号的能量，这种现象称为多径传播。 这迫使大多数现有的基于RF定位的系统做出折衷：要么模拟这种难以预测的多径衰落模式，要么利用昂贵的硬件以非常高的速率采样无线信号。 大多数现有的射频系统选择前者，建立多路径信号强度图[2,3,44,43]，或使用射频传播模型估算粗粒度偏差[11,14]，实现平均定位精度在60cm [43] 和米：但这对于手持设备的应用来说过于粗糙了。

Recently, however, two new opportunities have arisen in the design of indoor location systems:
1. WiFi AP正在使用越来越多的天线来增强多输入多输出（MIMO）技术的容量和覆盖范围。 实际上，我们预计在未来，接入点的天线数量将增加几倍，以满足MIMO链路和空间复用的需求[1,31]，从而增加总体容量。 事实上，即将到来的802.11ac标准将指定8个MIMO空间流，而自2010年以来已有16个天线AP可用[41]。
2. 同时，WiFi AP密度仍然很高：在我们的实验性基础设施被排除的情况下，来自我们测试平台大多数地点的传输到达七个或更多的网络AP，除了大约百分之五的地点达到五个或更多这样的AP。 此外，通过利用物理层实现的信号处理，AP可以以比接收和解码数据包所需的SNR更低的SNR从单个数据包提取信息。 这使得更多的ArrayTrack接入点能够协同定位客户端，而不是系统专门在更高层上运行。

ArrayTrack是一种室内定位系统，它利用商品AP上越来越多的天线为室内环境中的移动设备提供精细的位置。 当一个客户端在空中传输一个帧时，多个ArrayTrack AP偷听传输，并且每个计算来自客户端传入帧的到达角（AoA）信息。 然后，系统在中央后端服务器上聚合AP的AoA数据以估计客户的位置。 虽然AOA技术已经广泛用于雷达和声学，但是在室内实现这些技术的挑战是在这些环境中存在强大的多径RF传播。 为了解决这个问题，我们引入了新颖的系统设计技术和信号处理算法，即使在客户端和AP之间的直接路径上很少或没有能量到达的相对常见的情况下，也可以可靠地消除多路径的影响。

ArrayTrack以三种不同的方式提升定位的技术水平：1.为了减轻室内多路径传播的影响，ArrayTrack提供了一种新颖的多路径抑制算法，可有效消除客户端与AP之间的反射路径。 2.一旦检测到帧，ArrayTrack AP快速切换天线组合，从每个天线合成新的AoA信息。 我们将这种技术称为多样性合成，并且发现它在AP密度低的情况下特别有用。 3. ArrayTrack的系统架构围绕硬件，AP和软件，数据库后端进行并行处理，以实现快速的位置估算。

我们在Rice WARP FPGA平台上实现了ArrayTrack，并在一个繁忙的办公空间的一层中部署了一个41节点的网络。 在此设置中的实验结果表明，仅使用三个AP，ArrayTrack就可以将客户端定位到57厘米的中间位置，并且平均为一米精度。有6个AP的时候，ArrayTrack的中位数为23厘米，平均31厘米的位置精确度，95％的客户定位在90厘米以内。 与此同时，ArrayTrack速度很快，只需要100毫秒即可产生一个位置估计值。 据我们所知，这是迄今为止，对于基于射频的定位系统而言，最准确和响应性最高的位置估计，除了附近的WiFi接入点的正常密度之外，它不需要基础设施。 此外，正如我们通过实验所示，ArrayTrack的性能在不同的天线高度，不同的天线方向，低信噪比和冲突的情况下都很好。
## Conclusion
我们已经介绍了一种室内定位系统ArrayTrack，该系统使用到达角度技术来将室内无线客户端定位到以前只能通过昂贵的专用硬件基础设施才能达到的精度水平。 ArrayTrack将基于AoA的方向估计和空间平滑的最佳算法与新颖的算法相结合，用于抑制在室内频繁发生的非视线反射，并在AP处综合来自多个天线的信息。
## Design
我们将ArrayTrack的设计描述为通过系统的信息流，从物理天线阵列到AP硬件，再到中央ArrayTrack服务器，如图1所示。首先，ArrayTrack利用技术来检测信号强度非常低的数据包， 所以多个AP可以窃听到单个传输（§2.1）。 接下来，在每个AP上，ArrayTrack使用许多天线（第2.2节）生成AoA频谱：估计可能性与方位（§2.3），并消除多径传播的某些影响（§2.4）。 最后，系统将这些估计结合起来估计位置（§2.5），进一步消除多径效应。
#### Packet detection and buffer management
为了计算客户端的AoA频谱，AP只需要从该客户端偷听少量的帧（在2.4节中将会清楚地说明，在1到3之间）。 对于ArrayTrack的目的，帧的内容是不重要的，所以我们的系统可以处理控制帧，如确认（acknowledgments），甚至在链路层加密的帧。

801.11帧的物理层前同步码包含已知的短和长训练符号，如图2所示。我们使用Schmidl-Cox 检测的修正版本[25]来检测传入帧的短训练符号。 一旦检测模块检测到一个帧，就激活下一节中描述的分集综合机制，并将输入帧的采样存入一个循环缓冲区，每帧检测到一个逻辑缓冲区入口。

由于它甚至不需要部分数据包解码，所以我们的系统可以处理数据包的任何部分，这在CSMA——载波侦听多路访问网络（§4.3.5）中发生冲突时很有帮助。 我们的系统检测到数据包的前导码并记录它的一小部分。 原则上，一个时域数据包样本将为第2.3节所述的AoA光谱计算提供足够的信息。 然而，为了平均化噪声的影响，我们使用了10个样本（我们在第4.3.3节中证明了这一点）。 由于商品WiFi AP采样速率为40 Msamples /秒，这意味着我们处理一个数据包样本只需要250纳秒，在WiFi前导码的持续时间为16μs的1.5％的情况下。

#### Diversity synthesis
在检测到分组时，大多数商品AP在天线对之间切换，从具有最强信号的每对天线中选择天线，这种技术称为分集选择diversity selection。 这种众所周知且广泛实施的技术在存在天线之一处的破坏性多径衰落的情况下提高了性能，并且可以在当今最新的802.11n MIMO接入点中找到。 它还具有不增加无线电ratio数量的优点，从而节省了AP的成本。

ArrayTrack将 diversity selection无缝集成到其设计中，从 diversity pair的两个天线合成独立的AoA数据。 我们称这种技术多样性合成。

参考图1，一旦packet检测块已经指示帕packet的开始，控制逻辑就将与来自上面一组天线的前导码的长训练符号S0（图2）对应的样本存储到循环缓冲器条目circular buffer entry的前半部分。 接下来，控制逻辑切换图1中的AntSel（用于天线选择）线路，在第二个长训练符号S1的持续期间切换到下面一组天线。 (We use the long training symbols because our hardware radio platform has a 500 ns switching time during which the received signal is highly distorted and unusable)由于S1和S2是相同的，每个3.2μs长，它们都落在室内无线信道的相干时间(The time span over which the channel can be considered stationary. Coherence time is mainly a function of the RF carrier frequency and speed of motion of the transmitter, receiver, and any nearby objects.)之内，所以我们可以把从每组天线获得的信息看作是从两组同时获得的信息 AP上的不同无线电。

#### AoA spectrum generation
特别是在室内无线信道中，射频信号会从环境中的物体反射回来，导致信号的多个副本（copies）到达AP：这种现象被称为多径传播。 在多天线AP中，客户接收信号的AoA频谱是作为到达角的函数的输入信号功率的估计，如图3所示。由于在室内存在强多径传播，直达路径信号可能是显著弱于反射路径信号，甚至可能无法检测到。 在这些情况下，AoA频谱上的最高峰将对应于反射路径，而不是直接路径到客户端。 这使得仅使用AoA光谱的室内定位非常不准确，因此需要ArrayTrack处理链中的其余步骤。
###### Phased-array primer
为了解释我们如何产生AoA谱，我们现在简要介绍相控阵列。 虽然他们的技术已经成熟建立，但我们侧重于室内应用，并强调了由此产生的复杂性。

为了说明清楚，我们首先描述AP如何可以计算自由空间中的到达角信息（即在没有多路径反射的情况下），然后概括处理多路径无线传播的原理。 计算无线信号到达角的关键是分析AP上的接收相位，如图4（左）所示，即在沿从客户端到接入点的路径上的每个RF波长λ，从0到2π线性变化的一个数量。


###### Spatial smoothing for multipath distortion
###### Array geometry weighting
###### Array symmetry removal
#### Multipath suppression
尽管上述空间平滑算法（第2.3.2节）减少了AoA频谱的多径引起的失真，以产生精确的频谱，但是它们不能识别直接路径，留下多路径反射以降低系统精度。 我们在这里介绍的多路径抑制算法的目标是消除或减少与AP到客户端的直接路径无关的AoA频谱峰值。

ArrayTrack的多路径抑制算法利用了无线信道中发生的变化，这种变化产生于发射器或附近的物体的（通过将来自多个帧的AoA频谱组(group)在一起）移动（如果有的话）。 我们的方法受到如下观察的启发：当发射机，接收机或两者之间的物体运动较小时，AoA频谱上的直接路径峰值通常是稳定的，而反射路径峰值通常会显着变化， 举例来说，当我们拿着手机打电话时，这些轻微的动作在现实生活中经常发生。

我们在我们的测试平台中的100个随机选择的位置上运行微基准(microbenchmark)（参见图12，第7页），在选定的每个位置产生AoA光谱，并且在距离五厘米的位置产生AoA光谱。 如果两个频谱的相应方位峰值在5度以内，我们将该方位标记为不变。 如果变化超过五度或峰值消失，我们将其标记为已更改。

结果如表1所示。大部分时间，直接路径峰值不变而反射路径峰值改变。 这激发了图8所示的算法。注意，对于直接路径和反射路径峰值都没有变化的情况，我们保留所有这些都没有任何有害的后果。 另外，请注意，上面的microbenchmark只能捕获两个数据包。 如果我们在移动的过程中捕获多个数据包，这留下了进一步改进的空间。 在多路径抑制算法中唯一引起故障的情况是当反射路径峰值保持不变而直接路径峰值改变时。 但是，如上所示，发生这种情况的可能性很小。 我们在图9中显示算法运行的例子。
#### AoA spectra synthesis
在这一步中，ArrayTrack将几个AP的AoA光谱组合成最终的位置估计。 假设N个AP产生如前面步骤所处理的AoA谱P1（θ），...，PN（θ），并且我们希望计算客户端位于x处的可能性，如图3所示.ArrayTrack用三角法计算x到AP的方向i对应角度，θi的值，然后估计客户在位置x的可能性L（x）
L(x) = Π(i=1~N)Pi(θi). 
然后，我们使用公式8中定义的梯度，在网格中具有最高L（x）的三个位置上爬山(hill climbing )???，以改进我们的位置估计。
## Implementation
如图11所示，原型ArrayTrack AP使用两个基于Rice WARP FPGA的无线收发器。 每个WARP配备有四个无线电前端和四个全向天线。 我们利用其中一个WARP板上的数字 I /O引脚在两个WARP之间连接的线上输出时间同步脉冲，以便第二个WARP板能够记录和缓冲与第一个相同的时间索引样本。 WARP运行用Xilinx System Generator for DSP构建的定制FPGA硬件设计，实现了第2节中所述的所有功能。

我们将连接到WARP无线电的16个天线3放置成矩形几何形状（图11右）。 天线间隔半波长距离（6.13厘米），以产生最大的AoA光谱分辨率。 这也恰好产生了最大的MIMO无线容量，商品AP中的首选安排也是如此。
1. AP phase calibration.
对于ArrayTrack来说，为AP配备多个天线是必要的，但是不能像上一节所述计算到达角度。每个无线电接收机都包含一个2.4 GHz振荡器，其目的是将输入的射频信号转换为在I-Q空间中的表示形式，如图4（第4页）所示。这种下变换步骤的不良后果是它引起了一个未知的相位偏移到结果信号，使得AoA无法操作。这对于MIMO来说是允许的，但是对于我们的应用来说是不允许的，因为这表现为在图4中的星座点上添加了未知的相位。我们的解决方案是用USRP2校准阵列，产生连续的波音，直接测量每个相位偏移。由于SMA分线器和电缆的标签长度​​相同，所以存在较小的制造缺陷，我们建议一次性（对于特定的一组硬件只运行一次）校准方案来处理这些设备缺陷.

来自USRP2的信号在到达WARP无线电之前通过分离器和电缆（我们称之为外部路径）。 我们要测量的相位偏移Ph_off是内部相位差Ph_in2 - Ph_in1。 运行校准一次，我们获得以下偏移量:
Ph_off 1 = (Ph_ex2 + Ph_in2) − (Ph_ex1 + Ph_in1) (9)
由于设备缺陷，Phex2与Phex1稍有不同，因此Phoff 1不等于Phoff。 我们交换外部路径并再次运行校准：
Phoff 2 = (Phex1 + Phin2) − (Phex2 + Phin1) (10)
综合以上两个方程，我们得到Phoff和由设备缺陷造成的相位差：
(Phoff 2 + Phoff 1)/2 = Phoff (11)
(Phoff 2 − Phoff 1)/2 = Phex1 − Phex2 (12)
然后从接收信号中减去测得的相位偏移，即可消除未知的相位差，那么，AoA便成为可能。
2. Testbed clients.
我们在实验中使用的客户端是Soekris盒子，它配备了工作在2.4 GHz频段的Atheros 802.11g无线电。
